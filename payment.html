<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新潟屋内サバイバルゲーム - 料金支払い</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light background */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        /* Ensure content is below header and above footer */
        main {
            flex-grow: 1;
            padding-top: 64px; /* Height of header */
            padding-bottom: 64px; /* Height of footer */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e2e8f0;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        /* 各支払い方法のフォームを初期状態で非表示にする */
        .payment-form-section {
            display: none;
        }
        .payment-form-section.active {
            display: block;
        }
        /* エラーメッセージのスタイル */
        .error-message {
            color: #ef4444; /* Tailwind red-500 */
            font-size: 0.875rem; /* text-sm */
            margin-top: 0.25rem; /* mt-1 */
            display: none; /* 初期状態では非表示 */
        }
        .error-message.active {
            display: block;
        }
        .input-error {
            border-color: #ef4444; /* Tailwind red-500 */
            box-shadow: 0 0 0 1px #ef4444;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <header class="fixed top-0 left-0 w-full bg-gradient-to-r from-blue-600 to-indigo-700 text-white shadow-lg z-50 p-4 flex items-center justify-between">
        <div class="text-2xl font-bold tracking-wide">
            <a href="home.html" class="hover:text-blue-200 transition-colors duration-300">
                サバゲー新潟
            </a>
        </div>
        <nav>
            <ul class="flex space-x-6">
                <li><a href="home.html" class="hover:text-blue-200 transition-colors duration-300 font-medium">ホーム</a></li>
                <li><a href="contact.html" class="hover:text-blue-200 transition-colors duration-300 font-medium">お問い合わせ</a></li>
                <li><a href="login.html" class="hover:text-blue-200 transition-colors duration-300 font-medium">ログアウト</a></li>
            </ul>
        </nav>
    </header>

    <main class="flex-grow container mx-auto p-4 md:p-8 flex items-center justify-center">

        <section id="payment" class="bg-white p-8 md:p-12 rounded-xl shadow-2xl w-full max-w-2xl border border-gray-200">
            <h2 class="text-4xl font-extrabold text-center text-gray-900 mb-8">料金支払い</h2>
            <p class="text-lg text-gray-700 mb-6 text-center">予約内容をご確認の上、お支払い情報を入力してください。</p>

            <div class="mb-8 p-6 bg-blue-50 rounded-lg shadow-inner border border-blue-200">
                <h3 class="text-xl font-bold text-gray-800 mb-4">ご予約内容</h3>
                <p class="text-lg text-gray-700 mb-2"><strong>予約日時:</strong> <span id="payment-date-time">YYYY/MM/DD HH:MM</span></p>
                <p class="text-lg text-gray-700 mb-2"><strong>予約人数:</strong> <span id="payment-participants">X名</span></p>
                <p class="text-2xl font-bold text-blue-700">合計金額: <span id="payment-total-price">¥0</span> (税込)</p>
                <p class="text-sm text-gray-600 mt-2">※レンタル品の詳細は次の画面でご確認いただけます。</p>
            </div>

            <form id="paymentForm" class="space-y-6" onsubmit="return false;">
                <h3 class="text-2xl font-semibold text-gray-800 mb-4">支払い情報</h3>
                
                <div>
                    <label for="payment-method" class="block text-sm font-medium text-gray-700 mb-2">支払い方法</label>
                    <select id="payment-method" name="payment-method" required
                            class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-base">
                        <option value="">選択してください</option>
                        <option value="credit_card">クレジットカード</option>
                        <option value="convenience_store">コンビニ支払い</option>
                        <option value="qr_code">QRコード決済</option>
                    </select>
                </div>

                <div id="payment-forms-container">
                    <div id="credit_card-form" class="payment-form-section space-y-4">
                        <h4 class="text-xl font-bold text-gray-700 mt-4">クレジットカード情報</h4>
                        <div>
                            <label for="card-number" class="block text-sm font-medium text-gray-700 mb-2">カード番号</label>
                            <input type="text" id="card-number" name="card-number" placeholder="XXXX-XXXX-XXXX-XXXX" maxlength="19"
                                   class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-base"
                                   oninput="clearAllCreditCardErrors()">
                            <p id="card-number-error" class="error-message"></p>
                        </div>
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label for="expiry-month" class="block text-sm font-medium text-gray-700 mb-2">有効期限 (月)</label>
                                <input type="text" id="expiry-month" name="expiry-month" placeholder="MM" maxlength="2"
                                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-base"
                                       oninput="clearAllCreditCardErrors()">
                                <p id="expiry-month-error" class="error-message"></p>
                            </div>
                            <div>
                                <label for="expiry-year" class="block text-sm font-medium text-gray-700 mb-2">有効期限 (年)</label>
                                <input type="text" id="expiry-year" name="expiry-year" placeholder="YY" maxlength="2"
                                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-base"
                                       oninput="clearAllCreditCardErrors()">
                                <p id="expiry-year-error" class="error-message"></p>
                            </div>
                            <div>
                                <label for="cvv" class="block text-sm font-medium text-gray-700 mb-2">CVV</label>
                                <input type="text" id="cvv" name="cvv" placeholder="XXX" maxlength="4"
                                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-base"
                                       oninput="clearAllCreditCardErrors()">
                                <p id="cvv-error" class="error-message"></p>
                            </div>
                        </div>
                        <p id="credit-card-general-error" class="error-message text-center"></p> </div>

                    <div id="convenience_store-form" class="payment-form-section space-y-4">
                        <h4 class="text-xl font-bold text-gray-700 mt-4">コンビニ支払い</h4>
                        <p class="text-base text-gray-700">
                            以下のいずれかのコンビニエンスストアにてお支払いください。<br>
                            お支払いには「受付番号」と「確認コード」が必要です。
                        </p>
                        <div class="bg-gray-100 p-4 rounded-lg border border-gray-200">
                            <p class="text-sm text-gray-800 mb-1"><strong>受付番号:</strong> <span class="font-mono text-blue-700 text-lg">1234567890</span></p>
                            <p class="text-sm text-gray-800 mb-1"><strong>確認コード:</strong> <span class="font-mono text-blue-700 text-lg">9876</span></p>
                            <p class="text-sm text-gray-600 mt-2">
                                ※お支払い期限: 本日から3日以内<br>
                                ※対応コンビニ: セブン-イレブン、ファミリーマート、ローソン、ミニストップ、デイリーヤマザキなど
                            </p>
                        </div>
                        <p class="text-sm text-gray-600">
                            各コンビニエンスストアでの支払い方法は、上記コードをお控えの上、店頭端末をご利用いただくか、店員にお尋ねください。
                        </p>
                    </div>

                    <div id="qr_code-form" class="payment-form-section space-y-4">
                        <h4 class="text-xl font-bold text-gray-700 mt-4">QRコード決済</h4>
                        <p class="text-base text-gray-700">以下の中からご利用のQRコード決済サービスを選択し、画面の指示に従ってスキャンしてください。</p>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="flex flex-col items-center p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                                <img src="https://placehold.co/100x100?text=QR+Code+A" alt="QRコード決済A" class="w-24 h-24 mb-2">
                                <p class="text-sm font-medium text-gray-700">QRペイ</p>
                            </div>
                            <div class="flex flex-col items-center p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                                <img src="https://placehold.co/100x100?text=QR+Code+B" alt="QRコード決済B" class="w-24 h-24 mb-2">
                                <p class="text-sm font-medium text-gray-700">ペイペイ</p>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mt-2">※決済完了後、店舗スタッフが確認いたします。</p>
                    </div>
                </div>

                <div class="text-center mt-8">
                    <button type="button" onclick="processPayment()"
                            class="inline-flex items-center px-10 py-4 border border-transparent text-xl font-semibold rounded-lg shadow-lg text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-300 transform hover:-translate-y-0.5">
                        支払いを完了する
                    </button>
                </div>
            </form>
        </section>

    </main>

    <footer class="fixed bottom-0 left-0 w-full bg-gray-800 text-gray-300 shadow-inner z-50 p-4 text-center text-sm">
        <p>&copy; 2025 新潟屋内サバイバルゲーム. All rights reserved.</p>
        <div class="mt-2 space-x-4">
            <a href="#" class="hover:text-white transition-colors duration-300">プライバシーポリシー</a>
            <a href="#" class="hover:text-white transition-colors duration-300">利用規約</a>
        </div>
    </footer>

    <script>
        // エラーメッセージを表示するヘルパー関数
        function showErrorMessage(inputElement, errorMessageId, message) {
            const errorElement = document.getElementById(errorMessageId);
            errorElement.textContent = message;
            errorElement.classList.add('active');
            if (inputElement) {
                inputElement.classList.add('input-error');
            }
        }

        // エラーメッセージをクリアするヘルパー関数
        function clearErrorMessage(inputElement, errorMessageId) {
            const errorElement = document.getElementById(errorMessageId);
            errorElement.classList.remove('active');
            if (inputElement) {
                inputElement.classList.remove('input-error');
            }
        }

        // クレジットカード関連のエラーメッセージと入力スタイルを全てクリアする関数
        function clearAllCreditCardErrors() {
            const fields = ['card-number', 'expiry-month', 'expiry-year', 'cvv'];
            fields.forEach(fieldId => {
                const inputElement = document.getElementById(fieldId);
                clearErrorMessage(inputElement, `${fieldId}-error`);
            });
            document.getElementById('credit-card-general-error').classList.remove('active');
        }


        document.addEventListener('DOMContentLoaded', () => {
            const paymentMethodSelect = document.getElementById('payment-method');
            const paymentFormSections = document.querySelectorAll('.payment-form-section');

            function showPaymentForm(method) {
                paymentFormSections.forEach(section => {
                    section.classList.remove('active');
                    // フォームを切り替える際に、以前のエラーメッセージもクリアする
                    section.querySelectorAll('.error-message.active').forEach(err => err.classList.remove('active'));
                    section.querySelectorAll('.input-error').forEach(input => input.classList.remove('input-error'));
                });
                const selectedForm = document.getElementById(`${method}-form`);
                if (selectedForm) {
                    selectedForm.classList.add('active');
                }
            }

            paymentMethodSelect.addEventListener('change', (event) => {
                showPaymentForm(event.target.value);
            });

            const urlParams = new URLSearchParams(window.location.search);
            const total = urlParams.get('totalPrice');
            const participants = urlParams.get('participants');
            const date = urlParams.get('date');
            const time = urlParams.get('time');

            document.getElementById('payment-total-price').textContent = `¥${total ? parseInt(total).toLocaleString() : '0'}`;
            document.getElementById('payment-participants').textContent = `${participants ? participants : '1'}名`;
            document.getElementById('payment-date-time').textContent = `${date ? date : '未選択'} ${time ? time : ''}`;

            showPaymentForm(paymentMethodSelect.value);
        });

        /**
         * 支払い処理を実行します。
         * 選択された支払い方法に応じてバリデーションと確認メッセージを行います。
         */
        function processPayment() {
            const paymentMethod = document.getElementById('payment-method').value;
            let isValid = true;
            let confirmMessage = '';

            clearAllCreditCardErrors(); // まず全てのエラーをクリア

            if (paymentMethod === '') {
                alert('支払い方法を選択してください。');
                return;
            }

            if (paymentMethod === 'credit_card') {
                const cardNumberInput = document.getElementById('card-number');
                const expiryMonthInput = document.getElementById('expiry-month');
                const expiryYearInput = document.getElementById('expiry-year');
                const cvvInput = document.getElementById('cvv');

                const cardNumber = cardNumberInput.value.replace(/-/g, '');
                const expiryMonth = expiryMonthInput.value;
                const expiryYear = expiryYearInput.value;
                const cvv = cvvInput.value;

                if (!/^\d{13,19}$/.test(cardNumber)) {
                    showErrorMessage(cardNumberInput, 'card-number-error', 'カード番号が無効です。');
                    isValid = false;
                }

                const monthNum = parseInt(expiryMonth);
                if (!/^\d{1,2}$/.test(expiryMonth) || monthNum < 1 || monthNum > 12) {
                    showErrorMessage(expiryMonthInput, 'expiry-month-error', '月が無効です。');
                    isValid = false;
                }

                const currentYear = new Date().getFullYear() % 100;
                const yearNum = parseInt(expiryYear);
                if (!/^\d{2}$/.test(expiryYear) || yearNum < currentYear) {
                    showErrorMessage(expiryYearInput, 'expiry-year-error', '年が無効です。');
                    isValid = false;
                } else if (yearNum === currentYear && monthNum < (new Date().getMonth() + 1)) {
                     showErrorMessage(expiryMonthInput, 'expiry-month-error', '期限切れです。');
                     isValid = false;
                }

                if (!/^\d{3,4}$/.test(cvv)) {
                    showErrorMessage(cvvInput, 'cvv-error', 'CVVが無効です。');
                    isValid = false;
                }

                if (!isValid) {
                    // クレジットカード情報にエラーがある場合はここで処理中断
                    return;
                }
                confirmMessage = 'クレジットカードで支払いを完了します。よろしいですか？';

            } else if (paymentMethod === 'convenience_store') {
                confirmMessage = 'コンビニ支払いのお手続きに進みます。表示された受付番号と確認コードを控えて、コンビニでお支払いください。よろしいですか？';
            } else if (paymentMethod === 'qr_code') {
                confirmMessage = 'QRコード決済のお手続きに進みます。表示されたQRコードをスキャンして、お支払いください。よろしいですか？';
            }

            // 確認メッセージを表示
            if (confirm(confirmMessage)) {
                // 「OK」が押されたら、完了画面へ遷移
                window.location.href = 'completion.html';
            } else {
                // 「キャンセル」が押されたら、何もしない
                alert('支払いをキャンセルしました。');
            }
        }
    </script>
</body>
</html>